<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World of War</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="" />
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #title-screen,
        #shop-screen {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        #title-screen h1,
        #shop-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        #title-screen button,
        #shop-screen button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 1.2em;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #title-screen button:hover,
        #shop-screen button:hover {
            background: #666;
        }

        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 200px;
        }

        #hud div {
            margin: 5px 0;
        }

        #warp-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        #warp-menu button {
            display: block;
            margin: 5px 0;
            padding: 5px 10px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #warp-menu button:hover {
            background: #666;
        }

        #bomb-selection {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }

        #bomb-selection button {
            padding: 5px 10px;
            margin: 0 5px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #bomb-selection button:hover {
            background: #666;
        }

        #bomb-selection button.active {
            background: #00f;
        }

        #minimap {
            position: absolute;
            top: 10px;
            right: 150px;
            width: 200px;
            height: 150px;
            border: 2px solid #fff;
            z-index: 1000;
        }

        #notifications {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 300px;
            text-align: center;
        }

        .notification {
            background: rgba(0, 255, 0, 0.8);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            opacity: 1;
            transition: opacity 1s;
        }

        .notification.fade-out {
            opacity: 0;
        }
    </style>
</head>

<body>
    <div id="title-screen">
        <h1>World of War</h1>
        <button id="playBtn">Play</button>
        <button id="shopBtn">Shop</button>
        <button id="settingsBtn">Settings</button>
    </div>
    <div id="shop-screen" style="display: none;">
        <h1>Shop</h1>
        <div id="money">Money: 0</div>
        <button>Buy Standard Bomb (10)</button>
        <button>Buy Heavy Bomb (50)</button>
        <button>Buy Cluster Bomb (100)</button>
        <button>Back</button>
    </div>
    <div id="game-screen">
        <div id="hud">
            <div id="score">Score: 0</div>
            <div id="health">Health: 100</div>
            <div id="money-display">Money: 0</div>
            <div id="captured">Captured: None</div>
        </div>
        <div id="warp-menu">
            <button onclick="warpTo(40.7128, -74.0060)">New York</button>
            <button onclick="warpTo(51.5074, -0.1278)">London</button>
            <button onclick="warpTo(35.6762, 139.6503)">Tokyo</button>
            <button onclick="warpTo(-33.8688, 151.2093)">Sydney</button>
            <button onclick="warpTo(55.7558, 37.6173)">Moscow</button>
        </div>
        <div id="bomb-selection">
            <button id="standard-bomb" onclick="selectBomb('standard')">Standard</button>
            <button id="heavy-bomb" onclick="selectBomb('heavy')">Heavy</button>
            <button id="cluster-bomb" onclick="selectBomb('cluster')">Cluster</button>
        </div>
        <div id="notifications"></div>
        <div id="minimap"></div>
        <div id="map"></div>
    </div>

    <script>
        if (typeof L === 'undefined') {
            alert('Failed to load Leaflet library. Please check your internet connection and try again.');
        }

        const titleScreen = document.getElementById('title-screen');
        const shopScreen = document.getElementById('shop-screen');
        const gameScreen = document.getElementById('game-screen');
        const scoreDisplay = document.getElementById('score');
        const healthDisplay = document.getElementById('health');
        const moneyDisplay = document.getElementById('money-display');
        const capturedDisplay = document.getElementById('captured');
        const notifications = document.getElementById('notifications');
        const shopMoneyDisplay = document.getElementById('money');
        let map, minimap, playerMarker, playerMiniMarker, botMarkers = [], botMiniMarkers = [], bases = [], baseMiniMarkers = [], explosions = [];
        let score = 0, health = 100, money = 100, capturedCountries = [];
        let playerPos = [0, 0];
        const speed = 0.05;
        const keys = {};
        let selectedBomb = 'standard';
        let bombs = { standard: 10, heavy: 0, cluster: 0 };

        // Realistic SVG icon for player plane
        const playerIconSvg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 5 L15 15 H18 V25 H22 V15 H25 L20 5 Z" fill="#00f"/>
                    <path d="M18 25 H22 L23 28 H17 L18 25 Z" fill="#00f"/>
                    <path d="M15 15 H10 L12 20 H15 Z" fill="#00f"/>
                    <path d="M25 15 H30 L28 20 H25 Z" fill="#00f"/>
                    <path d="M20 5 L18 8 H22 L20 5 Z" fill="#00f"/>
                </svg>`;
        const playerIcon = L.divIcon({
            html: playerIconSvg,
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        const playerMiniIcon = L.divIcon({
            html: playerIconSvg,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // Realistic SVG icon for bot planes
        const botIconSvg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 5 L15 15 H18 V25 H22 V15 H25 L20 5 Z" fill="#f00"/>
                    <path d="M18 25 H22 L23 28 H17 L18 25 Z" fill="#f00"/>
                    <path d="M15 15 H10 L12 20 H15 Z" fill="#f00"/>
                    <path d="M25 15 H30 L28 20 H25 Z" fill="#f00"/>
                    <path d="M20 5 L18 8 H22 L20 5 Z" fill="#f00"/>
                </svg>`;
        const botIcon = L.divIcon({
            html: botIconSvg,
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        const botMiniIcon = L.divIcon({
            html: botIconSvg,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // SVG icon for bases
        const baseIconSvg = `
                <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="20" height="20" fill="#0f0"/>
                    <path d="M8 8 H24 V24 H8 Z" fill="#080"/>
                    <circle cx="16" cy="16" r="4" fill="#0f0"/>
                </svg>`;
        const baseIcon = L.divIcon({
            html: baseIconSvg,
            className: '',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
        const baseMiniIcon = L.divIcon({
            html: baseIconSvg,
            className: '',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        // SVG icon for explosions
        const explosionIconSvg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="15" fill="#ff4500" fill-opacity="0.7"/>
                    <circle cx="20" cy="20" r="10" fill="#ffa500" fill-opacity="0.7"/>
                    <circle cx="20" cy="20" r="5" fill="#ffff00" fill-opacity="0.7"/>
                </svg>`;

        // Add event listeners for title screen buttons
        document.getElementById('playBtn').addEventListener('click', startGame); // Play
        document.getElementById('shopBtn').addEventListener('click', showShop); // Shop
        document.getElementById('settingsBtn').addEventListener('click', () => alert('Settings not implemented')); // Settings

        // Add event listeners for shop screen buttons
        const shopButtons = document.querySelectorAll('#shop-screen button');
        shopButtons[0].addEventListener('click', () => buyBomb('standard', 10)); // Buy Standard Bomb
        shopButtons[1].addEventListener('click', () => buyBomb('heavy', 50)); // Buy Heavy Bomb
        shopButtons[2].addEventListener('click', () => buyBomb('cluster', 100)); // Buy Cluster Bomb
        shopButtons[3].addEventListener('click', backToTitle); // Back

        async function startGame() {
            try {
                titleScreen.style.display = 'none';
                shopScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                await new Promise(resolve => setTimeout(resolve, 100)); // Ensure DOM readiness
                if (!map) initMap();
                if (!minimap) initMinimap();
                if (botMarkers.length === 0) initBots();
                if (bases.length === 0) await initBases();
                updateHUD();
                updateBombSelection();
                gameLoop();
            } catch (error) {
                console.error('Failed to start game:', error);
                alert(`Failed to start game: ${error.message}. Please refresh and try again.`);
                resetGame();
            }
        }

        function showShop() {
            titleScreen.style.display = 'none';
            shopScreen.style.display = 'block';
            shopMoneyDisplay.textContent = `Money: ${money}`;
        }

        function backToTitle() {
            shopScreen.style.display = 'none';
            titleScreen.style.display = 'block';
        }

        function buyBomb(type, cost) {
            if (money >= cost) {
                money -= cost;
                bombs[type]++;
                shopMoneyDisplay.textContent = `Money: ${money}`;
                updateBombSelection();
                updateHUD();
            } else {
                alert('Not enough money!');
            }
        }

        function selectBomb(type) {
            if (bombs[type] > 0) {
                selectedBomb = type;
                updateBombSelection();
            } else {
                alert(`No ${type} bombs available!`);
            }
        }

        function updateBombSelection() {
            document.getElementById('standard-bomb').classList.toggle('active', selectedBomb === 'standard');
            document.getElementById('heavy-bomb').classList.toggle('active', selectedBomb === 'heavy');
            document.getElementById('cluster-bomb').classList.toggle('active', selectedBomb === 'cluster');
            document.getElementById('standard-bomb').textContent = `Standard (${bombs.standard})`;
            document.getElementById('heavy-bomb').textContent = `Heavy (${bombs.heavy})`;
            document.getElementById('cluster-bomb').textContent = `Cluster (${bombs.cluster})`;
        }

        function warpTo(lat, lng) {
            playerPos = [lat, lng];
            playerMarker.setLatLng(playerPos);
            playerMiniMarker.setLatLng(playerPos);
            map.panTo(playerPos);
        }

        function initMap() {
            try {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) throw new Error('Map container not found');
                map = L.map('map', {
                    center: [0, 0],
                    zoom: 5,
                    zoomControl: true
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                playerMarker = L.marker([0, 0], { icon: playerIcon }).addTo(map);
            } catch (error) {
                throw new Error('Failed to initialize main map: ' + error.message);
            }
        }

        function initMinimap() {
            try {
                const minimapContainer = document.getElementById('minimap');
                if (!minimapContainer) throw new Error('Minimap container not found');
                minimap = L.map('minimap', {
                    center: [0, 0],
                    zoom: 2,
                    zoomControl: false,
                    attributionControl: false
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(minimap);
                playerMiniMarker = L.marker([0, 0], { icon: playerMiniIcon }).addTo(minimap);
            } catch (error) {
                throw new Error('Failed to initialize minimap: ' + error.message);
            }
        }

        function initBots() {
            for (let i = 0; i < 3; i++) {
                const botPos = [
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                ];
                const bot = L.marker(botPos, { icon: botIcon }).addTo(map);
                const botMini = L.marker(botPos, { icon: botMiniIcon }).addTo(minimap);
                botMarkers.push({ marker: bot, pos: botPos });
                botMiniMarkers.push({ marker: botMini, pos: botPos });
            }
        }

        function initBases() {
            const landCoords = [
                { pos: [40.7128, -74.0060], country: 'USA' },
                { pos: [51.5074, -0.1278], country: 'UK' },
                { pos: [35.6762, 139.6503], country: 'Japan' },
                { pos: [-33.8688, 151.2093], country: 'Australia' },
                { pos: [55.7558, 37.6173], country: 'Russia' }
            ];
            return new Promise(resolve => {
                bases = [];
                baseMiniMarkers = [];
                for (let i = 0; i < 5; i++) {
                    const { pos, country } = landCoords[i % landCoords.length];
                    const base = L.marker(pos, { icon: baseIcon }).addTo(map);
                    const baseMini = L.marker(pos, { icon: baseMiniIcon }).addTo(minimap);
                    bases.push({ marker: base, pos, country, health: 100, active: true });
                    baseMiniMarkers.push({ marker: baseMini, pos });
                }
                resolve();
            });
        }

        function updateHUD() {
            scoreDisplay.textContent = `Score: ${score}`;
            healthDisplay.textContent = `Health: ${health}`;
            moneyDisplay.textContent = `Money: ${money}`;
            capturedDisplay.textContent = `Captured: ${capturedCountries.length > 0 ? capturedCountries.join(', ') : 'None'}`;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notifications.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 1000);
            }, 2000);
        }

        function createExplosion(pos, range) {
            const explosionIcon = L.divIcon({
                html: explosionIconSvg.replace('width="40"', `width="${range * 80}"`).replace('height="40"', `height="${range * 80}"`),
                className: '',
                iconSize: [range * 80, range * 80],
                iconAnchor: [range * 40, range * 40]
            });
            const explosion = L.marker(pos, { icon: explosionIcon }).addTo(map);
            const miniExplosion = L.marker(pos, { icon: explosionIcon }).addTo(minimap);
            const startTime = Date.now();
            explosions.push({ marker: explosion, miniMarker: miniExplosion, startTime });
        }

        function updateExplosions() {
            const now = Date.now();
            explosions = explosions.filter(ex => {
                const elapsed = now - ex.startTime;
                if (elapsed > 1000) {
                    ex.marker.remove();
                    ex.miniMarker.remove();
                    return false;
                }
                const opacity = 1 - elapsed / 1000;
                ex.marker.getElement().style.opacity = opacity;
                ex.miniMarker.getElement().style.opacity = opacity;
                return true;
            });
        }

        function gameLoop() {
            // Handle movement
            if (keys['w']) playerPos[0] += speed;
            if (keys['s']) playerPos[0] -= speed;
            if (keys['d']) playerPos[1] += speed;
            if (keys['a']) playerPos[1] -= speed;

            // Update player position
            playerMarker.setLatLng(playerPos);
            playerMiniMarker.setLatLng(playerPos);
            map.panTo(playerPos);

            // Move bots and check for collision
            botMarkers.forEach((bot, i) => {
                bot.pos[0] += (Math.random() - 0.5) * 0.02;
                bot.pos[1] += (Math.random() - 0.5) * 0.02;
                bot.marker.setLatLng(bot.pos);
                botMiniMarkers[i].marker.setLatLng(bot.pos);
                const dist = Math.sqrt(
                    (playerPos[0] - bot.pos[0]) ** 2 +
                    (playerPos[1] - bot.pos[1]) ** 2
                );
                if (dist < 0.2) {
                    health -= 5;
                    updateHUD();
                }
            });

            // Check for bomb (spacebar)
            if (keys[' '] && bombs[selectedBomb] > 0) {
                bombs[selectedBomb]--;
                updateBombSelection();
                let range = 0.5;
                if (selectedBomb === 'heavy') range = 0.7;
                if (selectedBomb === 'cluster') range = 1.0;
                createExplosion(playerPos, range);
                bases.forEach(base => {
                    if (!base.active) return;
                    const dist = Math.sqrt(
                        (playerPos[0] - base.pos[0]) ** 2 +
                        (playerPos[1] - base.pos[1]) ** 2
                    );
                    let damage = 0;
                    if (selectedBomb === 'standard' && dist < 0.5) damage = 20;
                    if (selectedBomb === 'heavy' && dist < 0.7) damage = 50;
                    if (selectedBomb === 'cluster' && dist < 1.0) damage = 80;
                    if (damage > 0) {
                        base.health -= damage;
                        if (base.health <= 0) {
                            base.active = false;
                            base.marker.remove();
                            baseMiniMarkers[bases.indexOf(base)].marker.remove();
                            score += 50;
                            money += 50;
                            bombs.standard += 2;
                            bombs.heavy += 1;
                            if (!capturedCountries.includes(base.country)) {
                                capturedCountries.push(base.country);
                                showNotification(`Captured ${base.country}! Gained 50 money, 2 standard bombs, 1 heavy bomb.`);
                            }
                            updateHUD();
                            updateBombSelection();
                        }
                    }
                });
            }

            // Update explosions
            updateExplosions();

            // Check lose condition
            if (health <= 0) {
                alert(`Game Over! Final Score: ${score}`);
                resetGame(true);
                return;
            }

            // Check win condition
            if (bases.every(base => !base.active)) {
                alert(`You win! Final Score: ${score}`);
                resetGame(true);
            }

            requestAnimationFrame(gameLoop);
        }

        function resetGame(fullReset = false) {
            // Clean up map and minimap
            if (map) {
                botMarkers.forEach(bot => bot.marker.remove());
                botMiniMarkers.forEach(bot => bot.marker.remove());
                bases.forEach(base => base.marker.remove());
                baseMiniMarkers.forEach(base => base.marker.remove());
                explosions.forEach(ex => { ex.marker.remove(); ex.miniMarker.remove(); });
                playerMarker.remove();
                playerMiniMarker.remove();
                map.remove();
                minimap.remove();
            }

            // Preserve or reset state
            if (fullReset) {
                score = 0;
                health = 100;
                money = 100;
                bombs = { standard: 10, heavy: 0, cluster: 0 };
                capturedCountries = [];
            }
            playerPos = [0, 0];
            botMarkers = [];
            botMiniMarkers = [];
            bases = [];
            baseMiniMarkers = [];
            explosions = [];
            selectedBomb = 'standard';

            // Reinitialize
            gameScreen.style.display = 'none';
            titleScreen.style.display = 'block';
            initMap();
            initMinimap();
            initBots();
            initBases().then(() => {
                updateHUD();
                updateBombSelection();
            });
        }

        // Keyboard controls
        document.addEventListener('keydown', e => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === 'Escape') {
                resetGame();
            }
        });
        document.addEventListener('keyup', e => {
            keys[e.key.toLowerCase()] = false;
        });
    </script>
</body>

</html>